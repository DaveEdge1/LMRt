<!DOCTYPE html>
<html >
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
      <title>Your 1st LMR reconstruction ever!</title>
    
      <link rel="stylesheet" href="../_static/pygments.css">
      <link rel="stylesheet" href="../_static/theme.css">
      <link rel="stylesheet" href="../_static/sphinx_press_theme.css">
      
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>

      <!-- sphinx script_files -->
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>

      
      <script src="../_static/theme-vendors.js"></script>
      <script src="../_static/theme.js" defer></script>
    
  <link rel="index" title="Index" href="../genindex.html" />
  <link rel="search" title="Search" href="../search.html" /> 
  </head>

  <body>
    <div id="app" class="theme-container" :class="pageClasses"><navbar @toggle-sidebar="toggleSidebar">
  <router-link to="../index.html" class="home-link">
    
      <span class="site-name">LMR Turbo</span>
    
  </router-link>

  <div class="links">
    <navlinks class="can-hide">



    </navlinks>
  </div>
</navbar>

      
      <div class="sidebar-mask" @click="toggleSidebar(false)">
      </div>
        <sidebar @toggle-sidebar="toggleSidebar">
          
          <navlinks>
            



            
          </navlinks><div id="searchbox" class="searchbox" role="search">
  <div class="caption"><span class="caption-text">Quick search</span>
    <div class="searchformwrapper">
      <form class="search" action="../search.html" method="get">
        <input type="text" name="q" />
        <input type="submit" value="Search" />
        <input type="hidden" name="check_keywords" value="yes" />
        <input type="hidden" name="area" value="default" />
      </form>
    </div>
  </div>
</div><div class="sidebar-links" role="navigation" aria-label="main navigation">
  
    <div class="sidebar-group">
      <p class="caption">
        <span class="caption-text"><a href="../index.html#how-to-cite">Contents</a></span>
      </p>
      <ul class="">
        
          <li class="toctree-l1 "><a href="../tutorial.html" class="reference internal ">Tutorial</a>

            
          </li>

        
          <li class="toctree-l1 "><a href="../ui.html" class="reference internal ">User Interface</a>

            
          </li>

        
      </ul>
    </div>
  
</div>
        </sidebar>

      <page>
          <div class="body-header" role="navigation" aria-label="navigation">
  
  <ul class="breadcrumbs">
    <li><a href="../index.html">Docs</a> &raquo;</li>
    
    <li>Your 1st LMR reconstruction ever!</li>
  </ul>
  

  <ul class="page-nav">
</ul>
  
</div>
<hr>
          <div class="content" role="main">
            
  <div class="section" id="your-1st-lmr-reconstruction-ever">
<h1>Your 1st LMR reconstruction ever!<a class="headerlink" href="#your-1st-lmr-reconstruction-ever" title="Permalink to this headline">¬∂</a></h1>
<p>This tutorial demonstrates the basic low-level workflow in LMRt. We will
assimilate coral records from the PAGES2k v2 database and use CCSM4 as
the prior. GISTEMP will be used as the instrumental temperature
observation for the calibration of the linear regression based PSM.
After this tutorial, you are expected to get your 1st LMR reconstruction
ever that is ready for analysis!</p>
<div class="section" id="test-data-preparation">
<h2>Test data preparation<a class="headerlink" href="#test-data-preparation" title="Permalink to this headline">¬∂</a></h2>
<p>To go through this tutorial, please prepare test data following the
steps: 1. Download the test case named ‚ÄúPAGES2k_CCSM4_GISTEMP‚Äù with this
<a class="reference external" href="https://drive.google.com/drive/folders/1UGn-LNd_tGSjPUKa52E6ffEM-ms2VD-N?usp=sharing">link</a>.
2. Create a directory named ‚Äútestcases‚Äù in the same directory where this
notebook sits. 3. Put the unzipped direcotry ‚ÄúPAGES2k_CCSM4_GISTEMP‚Äù
into ‚Äútestcases‚Äù.</p>
<p>Below, we first load some useful packages, including our <code class="docutils literal notranslate"><span class="pre">LMRt</span></code>.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">load_ext</span> autoreload
<span class="o">%</span><span class="k">autoreload</span> 2

<span class="kn">import</span> <span class="nn">LMRt</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>
</pre></div>
</div>
</div>
<div class="section" id="preprocessing">
<h2>Preprocessing<a class="headerlink" href="#preprocessing" title="Permalink to this headline">¬∂</a></h2>
<p>We will first create the <code class="docutils literal notranslate"><span class="pre">job</span></code> object and then perform the
preprocessing steps, after which the <code class="docutils literal notranslate"><span class="pre">job</span></code> will be ready to run.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">job</span> <span class="o">=</span> <span class="n">LMRt</span><span class="o">.</span><span class="n">ReconJob</span><span class="p">()</span>
<span class="n">job</span><span class="o">.</span><span class="n">load_configs</span><span class="p">(</span><span class="n">cfg_path</span><span class="o">=</span><span class="s1">&#39;./testcases/PAGES2k_CCSM4_GISTEMP/configs.yml&#39;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>[1m[36mLMRt: job.load_configs() &gt;&gt;&gt; loading reconstruction configurations from: ./testcases/PAGES2k_CCSM4_GISTEMP/configs.yml[0m
[1m[32mLMRt: job.load_configs() &gt;&gt;&gt; job.configs created[0m
[1m[36mLMRt: job.load_configs() &gt;&gt;&gt; job.configs[&quot;job_dirpath&quot;] = /Users/fzhu/Github/LMRt/docs/tutorial/testcases/PAGES2k_CCSM4_GISTEMP/recon[0m
[1m[32mLMRt: job.load_configs() &gt;&gt;&gt; /Users/fzhu/Github/LMRt/docs/tutorial/testcases/PAGES2k_CCSM4_GISTEMP/recon created[0m
{&#39;anom_period&#39;: [1951, 1980],
 &#39;job_dirpath&#39;: &#39;/Users/fzhu/Github/LMRt/docs/tutorial/testcases/PAGES2k_CCSM4_GISTEMP/recon&#39;,
 &#39;job_id&#39;: &#39;LMRt_quickstart&#39;,
 &#39;obs_path&#39;: {&#39;tas&#39;: &#39;./data/obs/gistemp1200_ERSSTv4.nc&#39;},
 &#39;obs_varname&#39;: {&#39;tas&#39;: &#39;tempanomaly&#39;},
 &#39;prior_path&#39;: {&#39;tas&#39;: &#39;./data/prior/tas_sfc_Amon_CCSM4_past1000_085001-185012.nc&#39;},
 &#39;prior_regrid_ntrunc&#39;: 42,
 &#39;prior_season&#39;: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12],
 &#39;prior_varname&#39;: {&#39;tas&#39;: &#39;tas&#39;},
 &#39;proxy_frac&#39;: 0.75,
 &#39;proxydb_path&#39;: &#39;./data/proxy/pages2k_dataset.pkl&#39;,
 &#39;psm_calib_period&#39;: [1850, 2015],
 &#39;ptype_psm&#39;: {&#39;coral.SrCa&#39;: &#39;linear&#39;,
               &#39;coral.calc&#39;: &#39;linear&#39;,
               &#39;coral.d18O&#39;: &#39;linear&#39;},
 &#39;ptype_season&#39;: {&#39;coral.SrCa&#39;: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12],
                  &#39;coral.calc&#39;: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12],
                  &#39;coral.d18O&#39;: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12]},
 &#39;recon_loc_rad&#39;: 25000,
 &#39;recon_nens&#39;: 100,
 &#39;recon_period&#39;: [0, 2000],
 &#39;recon_seeds&#39;: [0,
                 1,
                 2,
                 3,
                 4,
                 5,
                 6,
                 7,
                 8,
                 9,
                 10,
                 11,
                 12,
                 13,
                 14,
                 15,
                 16,
                 17,
                 18,
                 19],
 &#39;recon_timescale&#39;: 1,
 &#39;recon_vars&#39;: &#39;tas&#39;}
</pre></div>
</div>
<p>The 1st preprocessing step is to calibrate and forward the PSM, which
consists of: + loading the proxy database, and filtering and
seasonalizing the records + loading the instrumental observations (for
calibration) + loading the prior simulations (for forwarding) + perform
the calibration + perform the forward operator</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">job</span><span class="o">.</span><span class="n">load_proxydb</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>[1m[36mLMRt: job.load_proxydb() &gt;&gt;&gt; job.configs[&quot;proxydb_path&quot;] = /Users/fzhu/Github/LMRt/docs/tutorial/testcases/PAGES2k_CCSM4_GISTEMP/data/proxy/pages2k_dataset.pkl[0m
[1m[32mLMRt: job.load_proxydb() &gt;&gt;&gt; 692 records loaded[0m
[1m[32mLMRt: job.load_proxydb() &gt;&gt;&gt; job.proxydb created[0m
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">job</span><span class="o">.</span><span class="n">filter_proxydb</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>[1m[36mLMRt: job.filter_proxydb() &gt;&gt;&gt; filtering proxy records according to: [&#39;coral.d18O&#39;, &#39;coral.SrCa&#39;, &#39;coral.calc&#39;][0m
[1m[32mLMRt: job.filter_proxydb() &gt;&gt;&gt; 95 records remaining[0m
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">job</span><span class="o">.</span><span class="n">seasonalize_proxydb</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>[1m[36mLMRt: job.seasonalize_proxydb() &gt;&gt;&gt; seasonalizing proxy records according to: {&#39;coral.d18O&#39;: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12], &#39;coral.SrCa&#39;: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12], &#39;coral.calc&#39;: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12]}[0m
[1m[32mLMRt: job.seasonalize_proxydb() &gt;&gt;&gt; 95 records remaining[0m
[1m[32mLMRt: job.seasonalize_proxydb() &gt;&gt;&gt; job.proxydb updated[0m
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">job</span><span class="o">.</span><span class="n">load_prior</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>[1m[36mLMRt: job.load_prior() &gt;&gt;&gt; loading model prior fields from: {&#39;tas&#39;: &#39;/Users/fzhu/Github/LMRt/docs/tutorial/testcases/PAGES2k_CCSM4_GISTEMP/data/prior/tas_sfc_Amon_CCSM4_past1000_085001-185012.nc&#39;}[0m
Time axis not overlap with the reference period [1951, 1980]; use its own time period as reference [850.04, 1850.96].
[1m[30mLMRt: job.load_prior() &gt;&gt;&gt; raw prior[0m
Dataset Overview
-----------------------

     Name:  tas
   Source:  /Users/fzhu/Github/LMRt/docs/tutorial/testcases/PAGES2k_CCSM4_GISTEMP/data/prior/tas_sfc_Amon_CCSM4_past1000_085001-185012.nc
    Shape:  time:12012, lat:192, lon:288
[1m[32mLMRt: job.load_prior() &gt;&gt;&gt; job.prior created[0m
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">job</span><span class="o">.</span><span class="n">load_obs</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>[1m[36mLMRt: job.load_obs() &gt;&gt;&gt; loading instrumental observation fields from: {&#39;tas&#39;: &#39;/Users/fzhu/Github/LMRt/docs/tutorial/testcases/PAGES2k_CCSM4_GISTEMP/data/obs/gistemp1200_ERSSTv4.nc&#39;}[0m
[1m[32mLMRt: job.load_obs() &gt;&gt;&gt; job.obs created[0m
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>
<span class="n">job_dirpath</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">configs</span><span class="p">[</span><span class="s1">&#39;job_dirpath&#39;</span><span class="p">]</span>
<span class="n">seasonalized_prior_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">job_dirpath</span><span class="p">,</span> <span class="s1">&#39;seasonalized_prior.pkl&#39;</span><span class="p">)</span>
<span class="n">seasonalized_obs_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">job_dirpath</span><span class="p">,</span> <span class="s1">&#39;seasonalized_obs.pkl&#39;</span><span class="p">)</span>
<span class="n">prior_loc_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">job_dirpath</span><span class="p">,</span> <span class="s1">&#39;prior_loc.pkl&#39;</span><span class="p">)</span>
<span class="n">obs_loc_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">job_dirpath</span><span class="p">,</span> <span class="s1">&#39;obs_loc.pkl&#39;</span><span class="p">)</span>
<span class="n">calibed_psm_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">job_dirpath</span><span class="p">,</span> <span class="s1">&#39;calibed_psm.pkl&#39;</span><span class="p">)</span>

<span class="n">job</span><span class="o">.</span><span class="n">calibrate_psm</span><span class="p">(</span>
    <span class="n">seasonalized_prior_path</span><span class="o">=</span><span class="n">seasonalized_prior_path</span><span class="p">,</span>
    <span class="n">seasonalized_obs_path</span><span class="o">=</span><span class="n">seasonalized_obs_path</span><span class="p">,</span>
    <span class="n">prior_loc_path</span><span class="o">=</span><span class="n">prior_loc_path</span><span class="p">,</span>
    <span class="n">obs_loc_path</span><span class="o">=</span><span class="n">obs_loc_path</span><span class="p">,</span>
    <span class="n">calibed_psm_path</span><span class="o">=</span><span class="n">calibed_psm_path</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>[1m[36mLMRt: job.calibrate_psm() &gt;&gt;&gt; job.configs[&quot;precalc&quot;][&quot;seasonalized_prior_path&quot;] = /Users/fzhu/Github/LMRt/docs/tutorial/testcases/PAGES2k_CCSM4_GISTEMP/recon/seasonalized_prior.pkl[0m
[1m[36mLMRt: job.calibrate_psm() &gt;&gt;&gt; job.configs[&quot;precalc&quot;][&quot;seasonalized_obs_path&quot;] = /Users/fzhu/Github/LMRt/docs/tutorial/testcases/PAGES2k_CCSM4_GISTEMP/recon/seasonalized_obs.pkl[0m
[1m[36mLMRt: job.calibrate_psm() &gt;&gt;&gt; job.configs[&quot;precalc&quot;][&quot;prior_loc_path&quot;] = /Users/fzhu/Github/LMRt/docs/tutorial/testcases/PAGES2k_CCSM4_GISTEMP/recon/prior_loc.pkl[0m
[1m[36mLMRt: job.calibrate_psm() &gt;&gt;&gt; job.configs[&quot;precalc&quot;][&quot;obs_loc_path&quot;] = /Users/fzhu/Github/LMRt/docs/tutorial/testcases/PAGES2k_CCSM4_GISTEMP/recon/obs_loc.pkl[0m
[1m[36mLMRt: job.calibrate_psm() &gt;&gt;&gt; job.configs[&quot;precalc&quot;][&quot;calibed_psm_path&quot;] = /Users/fzhu/Github/LMRt/docs/tutorial/testcases/PAGES2k_CCSM4_GISTEMP/recon/calibed_psm.pkl[0m
[1m[36mLMRt: job.seasonalize_ds_for_psm() &gt;&gt;&gt; job.configs[&quot;ptype_season&quot;] = {&#39;coral.d18O&#39;: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12], &#39;coral.SrCa&#39;: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12], &#39;coral.calc&#39;: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12]}[0m
[1m[36mLMRt: job.seasonalize_ds_for_psm() &gt;&gt;&gt; Seasonalizing variables from prior with season: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12][0m
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>Searching nearest location:   0%|          | 0/95 [00:00&lt;?, ?it/s]
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>[1m[32mLMRt: job.seasonalize_ds_for_psm() &gt;&gt;&gt; job.seasonalized_prior created[0m
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>Searching nearest location: 100%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà| 95/95 [00:05&lt;00:00, 17.58it/s]
/Users/fzhu/Github/LMRt/LMRt/utils.py:243: RuntimeWarning: Mean of empty slice
  tmp = np.nanmean(var[inds, ...], axis=0)
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>[1m[32mLMRt: job.proxydb.find_nearest_loc() &gt;&gt;&gt; job.proxydb.prior_lat_idx &amp; job.proxydb.prior_lon_idx created[0m
[1m[32mLMRt: job.proxydb.get_var_from_ds() &gt;&gt;&gt; job.proxydb.records[pid].prior_time &amp; job.proxydb.records[pid].prior_value created[0m
[1m[36mLMRt: job.seasonalize_ds_for_psm() &gt;&gt;&gt; job.configs[&quot;ptype_season&quot;] = {&#39;coral.d18O&#39;: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12], &#39;coral.SrCa&#39;: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12], &#39;coral.calc&#39;: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12]}[0m
[1m[36mLMRt: job.seasonalize_ds_for_psm() &gt;&gt;&gt; Seasonalizing variables from obs with season: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12][0m
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>Searching nearest location:   7%|‚ñã         | 7/95 [00:00&lt;00:01, 61.08it/s]
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>[1m[32mLMRt: job.seasonalize_ds_for_psm() &gt;&gt;&gt; job.seasonalized_obs created[0m
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>Searching nearest location: 100%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà| 95/95 [00:01&lt;00:00, 64.02it/s]
Calibrating PSM:   6%|‚ñã         | 6/95 [00:00&lt;00:01, 59.89it/s]
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>[1m[32mLMRt: job.proxydb.find_nearest_loc() &gt;&gt;&gt; job.proxydb.obs_lat_idx &amp; job.proxydb.obs_lon_idx created[0m
[1m[32mLMRt: job.proxydb.get_var_from_ds() &gt;&gt;&gt; job.proxydb.records[pid].obs_time &amp; job.proxydb.records[pid].obs_value created[0m
[1m[32mLMRt: job.proxydb.init_psm() &gt;&gt;&gt; job.proxydb.records[pid].psm initialized[0m
[1m[36mLMRt: job.calibrate_psm() &gt;&gt;&gt; PSM calibration period: [1850, 2015][0m
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>Calibrating PSM:  67%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñã   | 64/95 [00:00&lt;00:00, 86.15it/s]
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">The</span> <span class="n">number</span> <span class="n">of</span> <span class="n">overlapped</span> <span class="n">data</span> <span class="n">points</span> <span class="ow">is</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="mf">25.</span> <span class="n">Skipping</span> <span class="o">...</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>Calibrating PSM: 100%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà| 95/95 [00:01&lt;00:00, 88.34it/s]
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>[1m[32mLMRt: job.proxydb.calib_psm() &gt;&gt;&gt; job.proxydb.records[pid].psm calibrated[0m
[1m[32mLMRt: job.proxydb.calib_psm() &gt;&gt;&gt; job.proxydb.calibed created[0m
CPU times: user 24.3 s, sys: 3.36 s, total: 27.7 s
Wall time: 20.3 s
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">job</span><span class="o">.</span><span class="n">forward_psm</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>Forwarding PSM: 100%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà| 95/95 [00:00&lt;00:00, 1455.54it/s]
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>[1m[32mLMRt: job.proxydb.forward_psm() &gt;&gt;&gt; job.proxydb.records[pid].psm forwarded[0m
</pre></div>
</div>
<p>The 2nd preprocessing step is to seasonalize and regrid the prior
fields.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">job</span><span class="o">.</span><span class="n">seasonalize_prior</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">job</span><span class="o">.</span><span class="n">regrid_prior</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>[1m[30mLMRt: job.seasonalize_prior() &gt;&gt;&gt; seasonalized prior w/ season [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12][0m
Dataset Overview
-----------------------

     Name:  tas
   Source:  /Users/fzhu/Github/LMRt/docs/tutorial/testcases/PAGES2k_CCSM4_GISTEMP/data/prior/tas_sfc_Amon_CCSM4_past1000_085001-185012.nc
    Shape:  time:1001, lat:192, lon:288
[1m[32mLMRt: job.seasonalize_ds_for_psm() &gt;&gt;&gt; job.prior updated[0m
[1m[30mLMRt: job.regrid_prior() &gt;&gt;&gt; regridded prior[0m
Dataset Overview
-----------------------

     Name:  tas
   Source:  /Users/fzhu/Github/LMRt/docs/tutorial/testcases/PAGES2k_CCSM4_GISTEMP/data/prior/tas_sfc_Amon_CCSM4_past1000_085001-185012.nc
    Shape:  time:1001, lat:42, lon:63
[1m[32mLMRt: job.regrid_prior() &gt;&gt;&gt; job.prior updated[0m
</pre></div>
</div>
<p>Now we are ready to dump the <code class="docutils literal notranslate"><span class="pre">job</span></code> object, so that we may quickly load
and continue the job any time we want without repeating the
preprocessing steps above. Note that the <code class="docutils literal notranslate"><span class="pre">job.seasonalized_prior</span></code> and
<code class="docutils literal notranslate"><span class="pre">job.seasonalized_obs</span></code> below are precalculated for PSM calibration,
which may consist fields apply to multiple seasonalities. We don‚Äôt need
them any more once the PSMs are calibrated, so we delete them before
dumping the <code class="docutils literal notranslate"><span class="pre">job</span></code> object to make the size minimal.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">job</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

<span class="c1"># The above equals to below:</span>
<span class="c1"># del(job.seasonalized_prior)</span>
<span class="c1"># del(job.seasonalized_obs)</span>
<span class="c1"># pd.to_pickle(job, os.path.join(job_dirpath, &#39;job.pkl&#39;))</span>
</pre></div>
</div>
</div>
<div class="section" id="data-assimilation">
<h2>Data assimilation<a class="headerlink" href="#data-assimilation" title="Permalink to this headline">¬∂</a></h2>
<p>Now we are ready to perform the assimilation steps. As an example, we
only run one Monte-Carlo itermation by setting
<code class="docutils literal notranslate"><span class="pre">recon_seeds=np.arange(1)</span></code>. To perform say, 10, iterations, one may
set <code class="docutils literal notranslate"><span class="pre">recon_seeds=np.arange(10)</span></code>.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>
<span class="c1"># job_dirpath = &#39;...&#39;  # set a correct directory path</span>
<span class="c1"># job = pd.read_pickle(os.path.join(job_dirpath, &#39;job.pkl&#39;))</span>
<span class="n">job</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">recon_seeds</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>KF updating:   3%|‚ñé         | 59/2001 [00:00&lt;00:03, 588.29it/s]
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>[1m[36mLMRt: job.run() &gt;&gt;&gt; job.configs[&quot;recon_seeds&quot;] = [0][0m
[1m[36mLMRt: job.run() &gt;&gt;&gt; job.configs[&quot;save_settings&quot;] = {&#39;compress_dict&#39;: {&#39;zlib&#39;: True, &#39;least_significant_digit&#39;: 1}, &#39;output_geo_mean&#39;: False, &#39;target_lats&#39;: [], &#39;target_lons&#39;: [], &#39;output_full_ens&#39;: False, &#39;dtype&#39;: 32}[0m
[1m[36mLMRt: job.run() &gt;&gt;&gt; job.configs saved to: /Users/fzhu/Github/LMRt/docs/tutorial/testcases/PAGES2k_CCSM4_GISTEMP/recon/job_configs.yml[0m
[1m[36mLMRt: job.run() &gt;&gt;&gt; seed: 0 | max: 0[0m
[1m[36mLMRt: job.run() &gt;&gt;&gt; randomized indices for prior and proxies saved to: /Users/fzhu/Github/LMRt/docs/tutorial/testcases/PAGES2k_CCSM4_GISTEMP/recon/job_r00_idx.pkl[0m
Proxy Database Overview
-----------------------
     Source:        /Users/fzhu/Github/LMRt/docs/tutorial/testcases/PAGES2k_CCSM4_GISTEMP/data/proxy/pages2k_dataset.pkl
       Size:        70
Proxy types:        {&#39;coral.calc&#39;: 6, &#39;coral.SrCa&#39;: 19, &#39;coral.d18O&#39;: 45}
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>KF updating: 100%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà| 2001/2001 [00:44&lt;00:00, 44.65it/s]
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>[1m[36mLMRt: job.save_recon() &gt;&gt;&gt; Reconstructed fields saved to: /Users/fzhu/Github/LMRt/docs/tutorial/testcases/PAGES2k_CCSM4_GISTEMP/recon/job_r00_recon.nc[0m
[1m[36mLMRt: job.run() &gt;&gt;&gt; DONE![0m
CPU times: user 6min 16s, sys: 16.1 s, total: 6min 33s
Wall time: 1min 32s
</pre></div>
</div>
<p>Once done, we will get the struture below in the ‚Äúrecon‚Äù directory:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>.
‚îú‚îÄ‚îÄ calibed_psm.pkl
‚îú‚îÄ‚îÄ job_configs.yml
‚îú‚îÄ‚îÄ job_r00_idx.pkl
‚îú‚îÄ‚îÄ job_r00_recon.nc
‚îú‚îÄ‚îÄ job.pkl
‚îú‚îÄ‚îÄ obs_loc.pkl
‚îú‚îÄ‚îÄ prior_loc.pkl
‚îú‚îÄ‚îÄ seasonalized_obs.pkl
‚îî‚îÄ‚îÄ seasonalized_prior.pkl
</pre></div>
</div>
</div>
</div>


          </div>
          <div class="page-nav">
            <div class="inner"><ul class="page-nav">
</ul><div class="footer" role="contentinfo">
      &#169; Copyright 2021, Feng Zhu.
    <br>
    Created using <a href="http://sphinx-doc.org/">Sphinx</a> 3.5.4 with <a href="https://github.com/schettino72/sphinx_press_theme">Press Theme</a>.
</div>
            </div>
          </div>
      </page>
    </div>
    
    
  </body>
</html>